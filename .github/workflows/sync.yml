name: 镜像搬运工
on:
  workflow_dispatch:
    inputs:
      img:
        description: '镜像名'
        required: true
        default: 'node:18-alpine'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 登录与双重测试
        run: |
          # 定义你的专属长地址和通用地址
          LONG_REG=crpi-qqjl0l7s0491bust.cn-hangzhou.personal.cr.aliyuncs.com
          SHORT_REG=registry.cn-hangzhou.aliyuncs.com
          
          # 尝试登录长地址
          echo "尝试登录专属长地址..."
          echo "${{ secrets.ACR_PASSWORD }}" | docker login $LONG_REG --username=${{ secrets.ACR_USERNAME }} --password-stdin || echo "长地址登录失败，尝试通用地址..."
          
          # 尝试登录通用地址
          echo "${{ secrets.ACR_PASSWORD }}" | docker login $SHORT_REG --username=${{ secrets.ACR_USERNAME }} --password-stdin

          # 执行搬运（这里我们先用通用地址试一次，因为那个长地址目前看起来 DNS 有问题）
          docker pull node:18-alpine
          docker tag node:18-alpine $SHORT_REG/lichunpeng/node:18-alpine
          docker push $SHORT_REG/lichunpeng/node:18-alpine
